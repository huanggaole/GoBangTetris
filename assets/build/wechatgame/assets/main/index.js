window.__require=function t(e,i,n){function o(c,r){if(!i[c]){if(!e[c]){var h=c.split("/");if(h=h[h.length-1],!e[h]){var p="function"==typeof __require&&__require;if(!r&&p)return p(h,!0);if(s)return s(h,!0);throw new Error("Cannot find module '"+c+"'")}c=h}var a=i[c]={exports:{}};e[c][0].call(a.exports,function(t){return o(e[c][1][t]||t)},a,a.exports,t,e,i,n)}return i[c].exports}for(var s="function"==typeof __require&&__require,c=0;c<n.length;c++)o(n[c]);return o}({gameScript:[function(t,e,i){"use strict";cc._RF.push(e,"3c122INnc9NcYM4ZvQAtYqU","gameScript");var n,o=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),s=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,c=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,i,n);else for(var r=t.length-1;r>=0;r--)(o=t[r])&&(c=(s<3?o(c):s>3?o(e,i,c):o(e,i))||c);return s>3&&c&&Object.defineProperty(e,i,c),c};Object.defineProperty(i,"__esModule",{value:!0});var c=cc._decorator,r=c.ccclass,h=c.property,p=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.nextSprite=null,e.boardSprite=null,e.whitePrefab=null,e.blackPrefab=null,e.upBtn=null,e.downBtn=null,e.leftBtn=null,e.rightBtn=null,e.scoreLabel=null,e.comboLabel=null,e.levelLabel=null,e.endBtn=null,e.exs=[],e.musicBtn=null,e.musicSprite=null,e.museSprite=null,e.bgm=null,e.eliminateClip=null,e.collapeClip=null,e.blocks=[[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]],[[1,1],[1,1]],[[1,0,0],[1,1,0],[0,1,0]],[[0,1,0],[1,1,0],[1,0,0]],[[1,0,0],[1,0,0],[1,1,0]],[[0,1,0],[0,1,0],[1,1,0]],[[0,1,0],[1,1,1],[0,0,0]]],e.next=null,e.current=null,e.currentpieces=[],e.pos=null,e.mapwidth=10,e.mapheight=23,e.map=[],e.mapPieces=[],e.levelnum=1,e.speed=.5,e.blockIndex=0,e.score=0,e.times=0,e}return o(e,t),e.prototype.start=function(){var t=this;this.initOpenContext();for(var e=0;e<this.mapheight;e++){for(var i=[],n=[],o=0;o<this.mapwidth;o++)i.push(0),n.push(null);this.map.push(i),this.mapPieces.push(n)}this.current=this.generateABlock(),this.next=this.generateABlock(),this.refreshNext(this.next),this.pos=new cc.Vec2(4,this.mapheight-1),this.addNewBlock(this.current,this.pos),this.scheduleOnce(function(){t.onMove()},this.speed),this.registeButtons(),this.endBtn.node.on("click",function(){cc.director.loadScene("GameScene")},this)},e.prototype.registeButtons=function(){this.upBtn.node.on("click",this.onUp,this),this.downBtn.node.on("click",this.onDown,this),this.leftBtn.node.on("click",this.onLeft,this),this.rightBtn.node.on("click",this.onRight,this),cc.systemEvent.on(cc.SystemEvent.EventType.KEY_DOWN,this.onKeyDown,this),this.musicBtn.node.on("click",this.onMusic,this)},e.prototype.unregisteButtons=function(){this.upBtn.node.off("click",this.onUp,this),this.downBtn.node.off("click",this.onDown,this),this.leftBtn.node.off("click",this.onLeft,this),this.rightBtn.node.off("click",this.onRight,this),cc.systemEvent.off(cc.SystemEvent.EventType.KEY_DOWN,this.onKeyDown,this),this.musicBtn.node.off("click",this.onMusic,this)},e.prototype.onMusic=function(){this.bgm.mute?(cc.audioEngine.setEffectsVolume(1),this.bgm.mute=!1,this.musicSprite.node.active=!0,this.museSprite.node.active=!1):(cc.audioEngine.setEffectsVolume(0),this.bgm.mute=!0,this.musicSprite.node.active=!1,this.museSprite.node.active=!0)},e.prototype.onKeyDown=function(t){switch(console.log(t),t.keyCode){case 87:this.onUp();break;case 65:this.onLeft();break;case 83:this.onDown();break;case 68:this.onRight();break;case 38:this.onUp();break;case 37:this.onLeft();break;case 40:this.onDown();break;case 39:this.onRight()}},e.prototype.onDown=function(){for(cc.Tween.stopAll(),this.unscheduleAllCallbacks();;){var t=new cc.Vec2(this.pos.x,this.pos.y-1);if(this.ifCollape(t)){this.endRound(this.pos);break}this.pos=t}},e.prototype.onUp=function(){for(var t=[],e=0;e<this.current.length;e++){for(var i=[],n=0;n<this.current[0].length;n++){var o=this.current[e][n];i.push(o)}t.push(i)}var s=this.current.length;for(e=1;e<=s/2;e++)for(n=e;n<s-e+1;n++){var c=this.current[e-1][n-1];this.current[e-1][n-1]=this.current[s-n][e-1],this.current[s-n][e-1]=this.current[s-e][s-n],this.current[s-e][s-n]=this.current[n-1][s-e],this.current[n-1][s-e]=c}if(this.ifCollape(this.pos))this.current=t;else{for(e=1;e<=s/2;e++)for(n=e;n<s-e+1;n++)c=this.currentpieces[e-1][n-1],this.currentpieces[e-1][n-1]=this.currentpieces[s-n][e-1],this.currentpieces[s-n][e-1]=this.currentpieces[s-e][s-n],this.currentpieces[s-e][s-n]=this.currentpieces[n-1][s-e],this.currentpieces[n-1][s-e]=c;this.movePieces(this.pos)}},e.prototype.onLeft=function(){var t=new cc.Vec2(this.pos.x-1,this.pos.y);this.ifCollape(t)||(this.pos=t,this.movePieces(this.pos))},e.prototype.onRight=function(){var t=new cc.Vec2(this.pos.x+1,this.pos.y);this.ifCollape(t)||(this.pos=t,this.movePieces(this.pos))},e.prototype.onMove=function(){var t=this,e=new cc.Vec2(this.pos.x,this.pos.y-1);this.ifCollape(e)?this.endRound(this.pos):(this.pos=e,this.movePieces(this.pos),this.scheduleOnce(function(){t.onMove()},2*this.speed))},e.prototype.endRound=function(t){cc.Tween.stopAll(),this.unscheduleAllCallbacks();for(var e=0;e<this.currentpieces.length;e++)for(var i=0;i<this.currentpieces[0].length;i++)if(null!=this.currentpieces[e][i]){var n=t.x+i,o=t.y-e;this.mapPieces[o][n]=this.currentpieces[e][i],this.map[o][n]=this.current[e][i],this.mapPieces[o][n].x=8*i-36+8*t.x,this.mapPieces[o][n].y=8*-e+96-8*(this.mapheight-t.y)}this.times=0,this.Eliminated()},e.prototype.nextRound=function(){var t=this;this.current=[];for(var e=0;e<this.next.length;e++){for(var i=[],n=0;n<this.next[0].length;n++){var o=this.next[e][n];i.push(o)}this.current.push(i)}this.next=this.generateABlock(),this.refreshNext(this.next),this.pos=new cc.Vec2(4,this.mapheight-1),this.addNewBlock(this.current,this.pos),this.ifCollape(this.pos)?(this.saveHighScore(),this.unregisteButtons(),this.endBtn.node.active=!0):(this.scheduleOnce(function(){t.onMove()},2*this.speed),this.registeButtons())},e.prototype.saveHighScore=function(){if("undefined"!=typeof wx){var t=wx.getStorageSync("highScore")||0;this.score>t&&(wx.setStorageSync("highScore",this.score),this.reportUserScore(this.score,function(){console.log("\u5206\u6570\u4e0a\u62a5\u5b8c\u6210\uff0c\u53ef\u4ee5\u663e\u793a\u6392\u884c\u699c")}))}else t=cc.sys.localStorage.getItem("highScore")||"0",this.score>parseInt(t)&&cc.sys.localStorage.setItem("highScore",this.score.toString())},e.prototype.Eliminated=function(){for(var t=this,e=[],i=[],n=[],o=[],s=[],c=[],r=0;r<this.mapheight;r++){for(var h=[],p=[],a=[],l=[],u=[],f=0;f<this.mapwidth;f++)h.push(!1),p.push(!1),a.push(!1),l.push(!1),u.push(!1);i.push(h),n.push(p),o.push(a),s.push(l),c.push(u)}for(r=0;r<this.mapheight;r++)for(f=0;f<this.mapwidth;f++){var d=this.map[r][f];if(0!=d){if(0==i[r][f]){for(var g=[],v=f;v<this.mapwidth&&this.map[r][v]==d;v++)i[r][v]=!0,g.push(new cc.Vec2(v,r));g.length>=5&&e.push(g)}if(0==n[r][f]){for(g=[],v=r;v<this.mapheight&&this.map[v][f]==d;v++)n[v][f]=!0,g.push(new cc.Vec2(f,v));g.length>=5&&e.push(g)}if(0==o[r][f]){g=[],v=r;for(var y=f;v<this.mapheight&&y<this.mapwidth&&this.map[v][y]==d;v++,y++)o[v][y]=!0,g.push(new cc.Vec2(y,v));g.length>=5&&e.push(g)}if(0==s[r][f]){for(g=[],v=r,y=f;v<this.mapheight&&y>=0&&this.map[v][y]==d;v++,y--)s[v][y]=!0,g.push(new cc.Vec2(y,v));g.length>=5&&e.push(g)}}}this.times+=e.length;var m=0;if(0==e.length)return this.nextRound(),!1;for(r=0;r<e.length;r++)for(g=e[r],f=0;f<g.length;f++)0==c[g[f].y][g[f].x]&&m++,c[g[f].y][g[f].x]=!0;return 1==this.times?this.comboLabel.string="    + "+m:this.comboLabel.string="    + "+this.times+" * "+m+"\nCombo * "+this.times,this.unregisteButtons(),this.scheduleOnce(function(){cc.audioEngine.playEffect(t.eliminateClip,!1);for(var i=0;i<e.length;i++)for(var n=e[i],o=0;o<n.length;o++)t.mapPieces[n[o].y][n[o].x].active=!1,t.comboLabel.node.active=!1;t.scheduleOnce(function(){for(var i=0;i<e.length;i++)for(var n=e[i],o=0;o<n.length;o++)t.mapPieces[n[o].y][n[o].x].active=!0,t.comboLabel.node.active=!0;t.scheduleOnce(function(){for(var i=0;i<e.length;i++)for(var n=e[i],o=0;o<n.length;o++)t.mapPieces[n[o].y][n[o].x].active=!1,t.comboLabel.node.active=!1;t.scheduleOnce(function(){for(var i=0;i<e.length;i++)for(var n=e[i],o=0;o<n.length;o++)t.mapPieces[n[o].y][n[o].x].active=!0,t.comboLabel.node.active=!0;t.scheduleOnce(function(){for(var i=0;i<e.length;i++)for(var n=e[i],o=0;o<n.length;o++)t.mapPieces[n[o].y][n[o].x].getComponent(cc.Sprite).spriteFrame=t.exs[0];t.scheduleOnce(function(){for(var i=0;i<e.length;i++)for(var n=e[i],o=0;o<n.length;o++)t.mapPieces[n[o].y][n[o].x].getComponent(cc.Sprite).spriteFrame=t.exs[1];t.scheduleOnce(function(){for(var i=0;i<e.length;i++)for(var n=e[i],o=0;o<n.length;o++)t.mapPieces[n[o].y][n[o].x].getComponent(cc.Sprite).spriteFrame=t.exs[2];t.scheduleOnce(function(){for(var i=0;i<e.length;i++)for(var n=e[i],o=0;o<n.length;o++)t.mapPieces[n[o].y][n[o].x].getComponent(cc.Sprite).spriteFrame=t.exs[3];t.scheduleOnce(function(){for(var i=0;i<e.length;i++)for(var n=e[i],o=0;o<n.length;o++)t.mapPieces[n[o].y][n[o].x].getComponent(cc.Sprite).spriteFrame=t.exs[4];t.scheduleOnce(function(){for(var i=0;i<e.length;i++)for(var n=e[i],o=0;o<n.length;o++)t.map[n[o].y][n[o].x]=0,t.boardSprite.node.removeChild(t.mapPieces[n[o].y][n[o].x]),t.mapPieces[n[o].y][n[o].x]=null;t.comboLabel.node.active=!1,t.score+=m*t.times,t.scoreLabel.string="\u5206\u6570: "+t.score,t.hangPiecesFall()},.05)},.05)},.05)},.05)},.05)},.05)},.2)},.2)},.2)},.2),!0},e.prototype.hangPiecesFall=function(){for(var t=[],e=[],i=0;i<this.mapheight;i++){for(var n=[],o=0;o<this.mapwidth;o++)0==this.map[i][o]?n.push(0):0==i?(n.push(2),e.push(new cc.Vec2(o,i))):n.push(1);t.push(n)}for(var s=0,c=[0,0,-1,1],r=[1,-1,0,0];s<e.length;){var h=e[s];for(s++,i=0;i<4;i++)(d=new cc.Vec2(h.x+c[i],h.y+r[i])).x>=0&&d.y>=0&&d.x<this.mapwidth&&d.y<this.mapheight&&1==t[d.y][d.x]&&(t[d.y][d.x]=2,e.push(d))}for(var p=2,a=[];;){var l=[],u=!1,f=[];for(s=0,i=0;i<this.mapheight;i++){for(o=0;o<this.mapwidth;o++)if(1==t[i][o]){p++,t[i][o]=p,l.push(new cc.Vec2(o,i)),f.push(new cc.Vec2(o,i)),u=!0;break}if(u)break}if(0==u)break;for(;s<f.length;)for(h=f[s],s++,i=0;i<4;i++){var d;(d=new cc.Vec2(h.x+c[i],h.y+r[i])).x>=0&&d.y>=0&&d.x<this.mapwidth&&d.y<this.mapheight&&1==t[d.y][d.x]&&(t[d.y][d.x]=p,f.push(d),l.push(d))}a.push(l)}this.continueFall(a,t)},e.prototype.continueFall=function(t,e){for(var i=this,n=!1,o=0;o<t.length;o++){for(var s=t[o],c=o+3,r=!0,h=0;h<s.length;h++)if(0==(l=s[h]).y||e[l.y-1][l.x]!=c&&0!=e[l.y-1][l.x]){r=!1;break}if(r){n=!0;var p=[],a=[];for(h=0;h<s.length;h++){var l=s[h];p.push(this.map[l.y][l.x]),this.map[l.y][l.x]=0,e[l.y][l.x]=0,a.push(this.mapPieces[l.y][l.x]),this.mapPieces[l.y][l.x]=null,s[h].y-=1}for(h=0;h<s.length;h++){l=s[h],this.map[l.y][l.x]=p[h],e[l.y][l.x]=c,this.mapPieces[l.y][l.x]=a[h];var u=this.mapPieces[l.y][l.x];cc.tween(u).to(.2,{x:8*l.x-36,y:8*l.y-88}).start()}}}n?this.scheduleOnce(function(){i.continueFall(t,e)},.4):this.Eliminated()},e.prototype.movePieces=function(t){cc.Tween.stopAll();for(var e=0;e<this.currentpieces.length;e++)for(var i=0;i<this.currentpieces[0].length;i++)if(null!=this.currentpieces[e][i]){var n=this.currentpieces[e][i];cc.tween(n).to(this.speed,{x:8*i-36+8*t.x,y:8*-e+96-8*(this.mapheight-t.y)}).start()}},e.prototype.ifCollape=function(t){for(var e=this.current,i=0;i<e.length;i++)for(var n=0;n<e[0].length;n++)if(0!=e[i][n]){var o=t.x+n,s=t.y-i;if(o<0||o>=this.mapwidth||s<0||s>this.mapheight)return cc.audioEngine.playEffect(this.collapeClip,!1),!0;if(0!=this.map[s][o])return cc.audioEngine.playEffect(this.collapeClip,!1),!0}return!1},e.prototype.generateABlock=function(){for(var t=[],e=this.blocks[Math.floor(Math.random()*this.blocks.length)],i=0;i<e.length;i++){for(var n=[],o=0;o<e[0].length;o++)0==e[i][o]?n.push(0):0==Math.floor(2*Math.random())?n.push(1):n.push(2);t.push(n)}return t},e.prototype.refreshNext=function(t){this.blockIndex++,this.levelnum=1+Math.floor(this.blockIndex/20),this.levelLabel.string="\u5173\u5361 "+this.levelnum,this.speed=.5*Math.pow(.9,this.levelnum-1),this.nextSprite.node.removeAllChildren();for(var e=0;e<t.length;e++)for(var i=0;i<t[0].length;i++){var n;if(1==t[e][i])n=cc.instantiate(this.whitePrefab);else{if(2!=t[e][i])continue;n=cc.instantiate(this.blackPrefab)}n.x=8*i-8,n.y=8*-e+8,this.nextSprite.node.addChild(n)}},e.prototype.addNewBlock=function(t,e){this.currentpieces=[];for(var i=0;i<t.length;i++){for(var n=[],o=0;o<t[0].length;o++){var s;if(1==t[i][o])s=cc.instantiate(this.whitePrefab);else{if(2!=t[i][o]){n.push(null);continue}s=cc.instantiate(this.blackPrefab)}s.x=8*o-36+8*e.x,s.y=8*-i+96-8*(this.mapheight-e.y),this.boardSprite.node.addChild(s),n.push(s)}this.currentpieces.push(n)}},e.prototype.initOpenContext=function(){"undefined"!=typeof wx&&(this._openContext=wx.getOpenDataContext())},e.prototype.reportUserScore=function(t,e,i){var n=this;"undefined"!=typeof wx&&wx.setUserCloudStorage({KVDataList:[{key:"score",value:""+t},{key:"level",value:""+this.levelnum}],success:function(){console.log("\u4e0a\u62a5\u5206\u6570\u6210\u529f:",t),null==e||e.apply(i),n._openContext&&n._openContext.postMessage({type:"engine",event:"updateRank",score:t,level:n.levelnum})},fail:function(t){console.log("\u4e0a\u62a5\u5206\u6570\u5931\u8d25:",t)}})},e.prototype.showRankList=function(){this._openContext&&this._openContext.postMessage({type:"engine",event:"showRank"})},e.prototype.hideRankList=function(){this._openContext&&this._openContext.postMessage({type:"engine",event:"hideRank"})},s([h(cc.Sprite)],e.prototype,"nextSprite",void 0),s([h(cc.Sprite)],e.prototype,"boardSprite",void 0),s([h(cc.Prefab)],e.prototype,"whitePrefab",void 0),s([h(cc.Prefab)],e.prototype,"blackPrefab",void 0),s([h(cc.Button)],e.prototype,"upBtn",void 0),s([h(cc.Button)],e.prototype,"downBtn",void 0),s([h(cc.Button)],e.prototype,"leftBtn",void 0),s([h(cc.Button)],e.prototype,"rightBtn",void 0),s([h(cc.Label)],e.prototype,"scoreLabel",void 0),s([h(cc.Label)],e.prototype,"comboLabel",void 0),s([h(cc.Label)],e.prototype,"levelLabel",void 0),s([h(cc.Button)],e.prototype,"endBtn",void 0),s([h([cc.SpriteFrame])],e.prototype,"exs",void 0),s([h(cc.Button)],e.prototype,"musicBtn",void 0),s([h(cc.Sprite)],e.prototype,"musicSprite",void 0),s([h(cc.Sprite)],e.prototype,"museSprite",void 0),s([h(cc.AudioSource)],e.prototype,"bgm",void 0),s([h(cc.AudioClip)],e.prototype,"eliminateClip",void 0),s([h(cc.AudioClip)],e.prototype,"collapeClip",void 0),s([r],e)}(cc.Component);i.default=p,cc._RF.pop()},{}],mainScript:[function(t,e,i){"use strict";cc._RF.push(e,"ba47an5tOBHqLZMk9nWfK3Q","mainScript");var n,o=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),s=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,c=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,i,n);else for(var r=t.length-1;r>=0;r--)(o=t[r])&&(c=(s<3?o(c):s>3?o(e,i,c):o(e,i))||c);return s>3&&c&&Object.defineProperty(e,i,c),c};Object.defineProperty(i,"__esModule",{value:!0});var c=cc._decorator,r=c.ccclass,h=c.property,p=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.startBtn=null,e.highScoreLabel=null,e.rankBtn=null,e.closeRankBtn=null,e.rankPageNode=null,e}return o(e,t),e.prototype.start=function(){var t=this;this.initOpenContext(),this.startBtn.node.on("click",function(){cc.director.loadScene("MainScene")}),this.rankBtn&&this.rankBtn.node.on("click",function(){t.showRankList()}),this.closeRankBtn&&(this.closeRankBtn.node.on("click",function(){t.hideRankList()}),this.closeRankBtn.node.active=!1),this.showHighScore()},e.prototype.showHighScore=function(){if("undefined"!=typeof wx){var t=wx.getStorageSync("highScore")||0;this.highScoreLabel&&(this.highScoreLabel.string="\u5386\u53f2\u6700\u9ad8\u5206: "+t)}else t=cc.sys.localStorage.getItem("highScore")||"0",this.highScoreLabel&&(this.highScoreLabel.string="\u5386\u53f2\u6700\u9ad8\u5206: "+t)},e.prototype.initOpenContext=function(){"undefined"!=typeof wx&&(this._openContext=wx.getOpenDataContext())},e.prototype.showRankList=function(){console.log("\u663e\u793a\u6392\u884c\u699c"),this.rankPageNode&&(this.rankPageNode.active=!0,console.log("\u663e\u793a\u6392\u884c\u699c\u9875\u9762\u7269\u4f53")),this.closeRankBtn&&(this.closeRankBtn.node.active=!0),this._openContext?this._openContext.postMessage({type:"engine",event:"showRank"}):console.log("\u6392\u884c\u699c\u529f\u80fd\u4ec5\u5728\u5fae\u4fe1\u5c0f\u6e38\u620f\u73af\u5883\u4e2d\u53ef\u7528")},e.prototype.hideRankList=function(){console.log("\u9690\u85cf\u6392\u884c\u699c"),this.rankPageNode&&(this.rankPageNode.active=!1,console.log("\u9690\u85cf\u6392\u884c\u699c\u9875\u9762\u7269\u4f53")),this.closeRankBtn&&(this.closeRankBtn.node.active=!1),this._openContext&&this._openContext.postMessage({type:"engine",event:"hideRank"})},s([h(cc.Button)],e.prototype,"startBtn",void 0),s([h(cc.Label)],e.prototype,"highScoreLabel",void 0),s([h(cc.Button)],e.prototype,"rankBtn",void 0),s([h(cc.Button)],e.prototype,"closeRankBtn",void 0),s([h(cc.Node)],e.prototype,"rankPageNode",void 0),s([r],e)}(cc.Component);i.default=p,cc._RF.pop()},{}]},{},["gameScript","mainScript"]);